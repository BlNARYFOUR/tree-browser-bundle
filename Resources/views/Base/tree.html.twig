<script type="text/javascript" src="{{ asset('bundles/fosjsrouting/js/routing.js') }}"></script>
<script type="text/javascript" src="{{ path('fos_js_routing_js') }}"></script>

<script src="{{ asset('bundles/symfonycmftree/js/jstree/jquery.jstree.js') }}" type="text/javascript"></script>

<script type="text/javascript">
    
    (function ($) {
        $.phpcrbrowser = {};
        
        $.phpcrbrowser.getUrl = function (target, node_id) {
            {% set token = '@@ID@@' %}
            
            var base_urls = {
                "create":   "{% block create_base_url %}{% endblock %}",
                "delete":   "{% block delete_base_url %}{% endblock %}",
                "edit":     "{% block edit_base_url %}{% endblock %}",
            }

            return base_urls[target].replace("{{ token | url_encode }}", node_id);
        }
    })(jQuery);

    function initTree(selector) {

        jQuery(selector).jstree({ 
            "plugins" :     [ "contextmenu", "themes", "types", "ui", "json_data" ],
            "json_data": {
                "ajax": {
                    url:    "{{ path('symfony_cmf_phpcr_browser_children') }}",
                    data:   function (node) {
                        return { 'root' : jQuery(node).attr('id') };
                    }
                }
            },
            "types": {
                "max_depth":        -2,
                "max_children":     -2,
                "valid_children":  [ "folder" ],
                "types": {
                    "default": {
                        "valid_children": "none",
                        "icon": {
                            "image": "{{ asset('bundles/symfonycmftree/images/document.png') }}"
                        }
                    },
                    "folder": {
                        "valid_children": [ "default", "folder" ],
                        "icon": {
                            "image": "{{ asset('bundles/symfonycmftree/images/folder.png') }}"
                        }
                    }
                }
            },
            "contextmenu": {
                "items": {
                    "rename":   null,
                    "remove":   null,
                    "ccp":      null,
                    "create": {
                        "label":    "Create",
                        "action":   function (node) {
                                        window.location = jQuery.phpcrbrowser.getUrl('create', node.attr("id"));
                                    }
                    },
                    "delete": {
                        "label":    "Delete",
                        "action":   function (node) {
                                        window.location = jQuery.phpcrbrowser.getUrl('delete', node.attr("id"));
                                    }
                    }
                }
            }
        })
        .bind("select_node.jstree", function (event, data) {
            window.location = jQuery.phpcrbrowser.getUrl('edit', data.rslt.obj.attr("id"));
        })
        .delegate("a", "click", function (event, data) { event.preventDefault(); });
    }

    $(document).ready(function() {
        initTree("{% block selector %}{% endblock %}");
    });

</script>